<!DOCTYPE html>
<html>
<head>
    <title>Starforged Architect v13: Robust Interactions</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* --- CORE STYLING --- */
        :root {
            --bg: #050508; --panel: #121218; --border: #2a2a35;
            --accent: #38bdf8; --warn: #e05a3e; --text-main: #e2e8f0; --text-muted: #94a3b8;
            --track-empty: #222; --track-fill: #fff;
            --rank-troublesome: #4ade80; --rank-dangerous: #facc15; 
            --rank-formidable: #fb923c; --rank-extreme: #f87171; --rank-epic: #c084fc;
            --health: #ef4444; --spirit: #38bdf8; --supply: #4ade80;
        }
        body { 
            font-family: 'Segoe UI', 'Roboto', Helvetica, Arial, sans-serif; 
            background: var(--bg); color: var(--text-main); 
            margin: 0; height: 100dvh; overflow: hidden; display: flex;
            user-select: none;
        }

        /* --- LAYOUTS --- */
        #wizard-container, #dashboard-container { width: 100%; height: 100%; display: flex; flex-direction: column; overflow-y: auto; }
        #dashboard-container { display: none; } 

        /* --- WIZARD --- */
        .step-container { max-width: 600px; margin: 40px auto; padding: 20px; background: var(--panel); border: 1px solid var(--border); border-radius: 8px; }
        .step-header { text-align: center; border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 20px; }
        .step-title { font-size: 1.5em; font-weight: bold; color: var(--accent); text-transform: uppercase; }
        .input-group { margin-bottom: 15px; }
        label { display: block; color: var(--text-muted); font-size: 0.8em; margin-bottom: 5px; letter-spacing: 1px; }
        input, textarea, select { width: 100%; padding: 10px; background: #1a1a22; border: 1px solid var(--border); color: #fff; border-radius: 4px; box-sizing: border-box; }
        button { padding: 10px 20px; background: var(--panel); color: #fff; border: 1px solid var(--border); border-radius: 4px; cursor: pointer; }
        button.primary { background: var(--accent); color: #000; border: none; font-weight: bold; }

        /* --- DASHBOARD HEADER & PORTRAIT --- */
        #dash-header { padding: 10px 20px; background: var(--panel); border-bottom: 1px solid var(--border); display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; }
        .header-left { text-align: left; }
        .char-name { font-size: 1.5em; font-weight: bold; letter-spacing: 1px; display: block; line-height: 1.1; color: var(--accent); }
        .char-pronouns { font-size: 0.9em; color: var(--text-muted); }
        .header-center { display: flex; justify-content: center; }
        #char-portrait {
            width: 120px; height: 120px; background: #000; border: 2px solid var(--border); border-radius: 8px;
            background-size: cover; background-position: center; cursor: pointer; position: relative; overflow: hidden;
            box-shadow: 0 0 15px rgba(0,0,0,0.5); transition: border-color 0.2s;
        }
        #char-portrait:hover { border-color: var(--accent); }
        #char-portrait::after { content: 'UPLOAD'; position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.8); color: #fff; font-size: 0.7em; text-align: center; padding: 4px; opacity: 0; transition: opacity 0.2s; }
        #char-portrait:hover::after { opacity: 1; }
        #portrait-input { display: none; }
        .header-right { text-align: right; display: flex; gap: 10px; justify-content: flex-end; }

        /* --- DASHBOARD GRID --- */
        #dash-grid { display: grid; grid-template-columns: 300px 1fr 420px; gap: 20px; padding: 20px; flex-grow: 1; overflow-y: auto; }

        .box { background: var(--panel); border: 1px solid var(--border); padding: 15px; border-radius: 6px; margin-bottom: 15px; position: relative; }
        .box-title { font-size: 0.75em; color: var(--text-muted); text-transform: uppercase; display: flex; justify-content: space-between; margin-bottom: 8px; }

        /* METERS */
        .meter-grid { display: flex; justify-content: space-between; gap: 10px; text-align: center; }
        .meter-item { flex: 1; background: #000; border: 1px solid var(--border); border-radius: 6px; padding: 10px 5px; cursor: pointer; transition: background 0.2s; }
        .meter-item:active { background: #222; }
        .meter-label { font-size: 0.7em; color: var(--text-muted); text-transform: uppercase; display: block; margin-bottom: 5px; }
        .meter-val { font-size: 2em; font-weight: bold; line-height: 1; display: block; }
        .val-health { color: var(--health); } .val-spirit { color: var(--spirit); } .val-supply { color: var(--supply); }

        /* TRACKS */
        .track-row { display: flex; gap: 4px; height: 12px; }
        .track-pip { flex: 1; background: var(--track-empty); border-radius: 2px; cursor: pointer; }
        .track-pip.filled { background: var(--text-main); }
        .track-row.locked { opacity: 0.3; pointer-events: none; border: 1px dashed var(--warn); }

        /* MOMENTUM */
        .mom-track { display: flex; justify-content: space-between; margin-top: 5px; background: #08080a; padding: 4px; border-radius: 4px; }
        .mom-step { width: 20px; height: 20px; text-align: center; line-height: 20px; font-size: 0.75em; color: #444; cursor: pointer; border-radius: 2px; position: relative; }
        .mom-step.active { background: var(--text-main); color: #000; font-weight: bold; }
        .mom-step.reset::after { content: ''; position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; background: var(--accent); border-radius: 50%; }
        .mom-step.max::after { content: ''; position: absolute; top: -4px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 4px solid transparent; border-right: 4px solid transparent; border-top: 4px solid var(--warn); }
        .mom-step.disabled { opacity: 0.2; pointer-events: none; }

        /* PROGRESS TRACKS */
        .prog-track { display: flex; gap: 2px; margin-top: 5px; background: #000; padding: 2px; }
        .prog-box { flex: 1; height: 20px; background: #1a1a22; border: 1px solid #445; cursor: pointer; }
        .prog-box[data-ticks="1"] { background: linear-gradient(to bottom right, transparent 48%, #fff 48%, #fff 52%, transparent 52%); }
        .prog-box[data-ticks="2"] { background: linear-gradient(to bottom right, transparent 48%, #fff 48%, #fff 52%, transparent 52%), linear-gradient(to top right, transparent 48%, #fff 48%, #fff 52%, transparent 52%); }
        .prog-box[data-ticks="3"] { background: linear-gradient(to bottom right, transparent 48%, #fff 48%, #fff 52%, transparent 52%), linear-gradient(to top right, transparent 48%, #fff 48%, #fff 52%, transparent 52%), linear-gradient(to right, transparent 48%, #fff 48%, #fff 52%, transparent 52%); }
        .prog-box[data-ticks="4"] { background: #fff; }

        /* TRACK CARD */
        .track-card { background: #1a1a20; padding: 10px; margin-bottom: 10px; border-left: 3px solid #555; border-radius: 0 4px 4px 0; }
        .track-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.8em; color: #889; margin-bottom: 4px; }
        .track-name { font-weight: bold; color: #fff; }
        .btn-mark { background: #222; border: 1px solid #444; color: var(--accent); padding: 2px 8px; font-size: 0.8em; cursor: pointer; min-width: 25px;}
        .btn-mark:hover { background: var(--accent); color: #000; }
        .btn-mark-neg { color: var(--warn); }
        .btn-mark-neg:hover { background: var(--warn); color: #000; }
        
        .rank-Troublesome { border-color: var(--rank-troublesome); } .rank-Dangerous { border-color: var(--rank-dangerous); }
        .rank-Formidable { border-color: var(--rank-formidable); } .rank-Extreme { border-color: var(--rank-extreme); } .rank-Epic { border-color: var(--rank-epic); }

        /* ASSETS & IMPACTS */
        .impact-group { margin-bottom: 10px; border-bottom: 1px solid #222; padding-bottom: 5px; }
        .impact-label { font-size: 0.75em; color: #667; margin-bottom: 4px; }
        .impact-toggle { display: inline-block; padding: 4px 8px; font-size: 0.75em; background: #1a1a22; border: 1px solid #334; border-radius: 3px; cursor: pointer; margin-right: 5px; color: #889; margin-bottom: 3px; }
        .impact-toggle.active { background: var(--warn); color: #000; border-color: var(--warn); font-weight: bold; }
        .trouble-toggle { display: inline-block; font-size: 0.75em; color: #889; border: 1px solid #445; padding: 2px 6px; border-radius: 3px; cursor: pointer; margin-right: 5px; }
        .trouble-toggle.active { background: #7f1d1d; color: #fca5a5; border-color: #ef4444; font-weight: bold;}

        .asset-card { background: #181820; border: 1px solid #445; padding: 10px; margin-bottom: 15px; border-radius: 4px; transition: opacity 0.3s; }
        .asset-card.disabled { opacity: 0.4; border-style: dashed; }
        .asset-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334; padding-bottom: 5px; margin-bottom: 5px; }
        .asset-cat { font-size: 0.6em; text-transform: uppercase; color: var(--accent); letter-spacing: 1px; }
        .asset-input { background: rgba(0,0,0,0.3); border: 1px solid #334; color: #fff; padding: 4px; font-size: 0.9em; width: 100%; box-sizing: border-box; }
        .ability-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: flex-start; }
        .ability-chk { margin-top: 4px; width: 16px; height: 16px; flex-shrink: 0; accent-color: var(--accent); }
        .ability-text { font-size: 0.8em; color: #aab; line-height: 1.3; }
        .misc-row { display: flex; gap: 5px; margin-top: 8px; }
        .misc-input { flex: 1; background: #111; border: 1px solid #334; color: #aaa; padding: 4px; font-size: 0.8em; }

        /* STAT BLOCK */
        .stat-block-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; text-align: center;}
        .stat-cell { background: #111; border: 1px solid #334; border-radius: 4px; padding: 10px 2px; }
        .stat-cell label { font-size: 0.6em; color: var(--text-muted); text-transform: uppercase; margin-top: 5px; display: block; }
        .stat-cell input { width: 100%; background: transparent; border: none; font-size: 1.4em; font-weight: bold; text-align: center; color: #fff; padding: 0; }

        /* UPLOAD ZONE */
        #db-drop-zone { border: 2px dashed #445; padding: 10px; text-align: center; color: #667; font-size: 0.8em; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; }
        #db-drop-zone.hover { border-color: var(--accent); color: var(--accent); }
        #db-file-input { display: none; }

        @media (max-width: 1000px) { 
            #dash-grid { grid-template-columns: 1fr; } 
            #dash-header { grid-template-columns: 1fr; text-align: center; gap: 10px; }
            .header-center { order: -1; }
            .header-right { justify-content: center; }
            .header-left { text-align: center; }
        }
    </style>
</head>
<body>

    <div id="wizard-container">
        <div id="step-1" class="step-container">
            <div class="step-header"><div class="step-title">Identity</div></div>
            <div class="input-group"><label>NAME</label><input type="text" id="in-name" placeholder="Name"></div>
            <div class="input-group"><label>PRONOUNS</label><input type="text" id="in-pronouns" placeholder="e.g. they/them"></div>
            <div class="input-group"><label>LOOK</label><textarea id="in-look" rows="2"></textarea></div>
            <div class="input-group"><label>BACKGROUND VOW (EPIC)</label><textarea id="in-vow" rows="2" placeholder="Epic Goal"></textarea></div>
            <div style="font-size:0.8em; color:#667; margin-bottom:10px;">Reminder: Assign 3, 2, 2, 1, 1 to Stats in the dashboard.</div>
            <button class="primary" onclick="finishWizard()">Launch System</button>
        </div>
    </div>

    <div id="dashboard-container">
        <div id="dash-header">
            <div class="header-left">
                <span id="disp-name" class="char-name">NAME</span> 
                <span id="disp-pronouns" class="char-pronouns"></span>
            </div>
            <div class="header-center">
                <div id="char-portrait" onclick="document.getElementById('portrait-input').click()"></div>
                <input type="file" id="portrait-input" accept="image/*" onchange="loadPortrait(this)">
            </div>
            <div class="header-right">
                <button onclick="saveCharacter()">SAVE</button>
                <button onclick="document.getElementById('load-input').click()">LOAD</button>
                <input type="file" id="load-input" style="display:none;" onchange="loadCharacter(this)">
            </div>
        </div>

        <div id="dash-grid">
            
            <div>
                <div class="box">
                    <div class="box-title">Impacts & Conditions</div>
                    <div class="impact-group">
                        <div class="impact-label">MISFORTUNES</div>
                        <span class="impact-toggle" onclick="toggleImpact('wounded')">Wounded</span>
                        <span class="impact-toggle" onclick="toggleImpact('shaken')">Shaken</span>
                        <span class="impact-toggle" onclick="toggleImpact('unprepared')">Unprepared</span>
                    </div>
                    <div class="impact-group">
                        <div class="impact-label">BURDENS</div>
                        <span class="impact-toggle" onclick="toggleImpact('doomed')">Doomed</span>
                        <span class="impact-toggle" onclick="toggleImpact('tormented')">Tormented</span>
                        <span class="impact-toggle" onclick="toggleImpact('indebted')">Indebted</span>
                    </div>
                    <div class="impact-group" style="border:none;">
                        <div class="impact-label">PERMANENT</div>
                        <span class="impact-toggle" onclick="toggleImpact('maimed')">Perm. Harmed</span>
                        <span class="impact-toggle" onclick="toggleImpact('traumatized')">Traumatized</span>
                    </div>
                    <div style="margin-top:10px; font-size:0.75em; color:#667; text-align:center;">
                        Max Momentum: <span id="disp-max-mom" style="color:#fff;">10</span> | Reset: <span id="disp-reset-mom" style="color:#fff;">+2</span>
                    </div>
                </div>

                <div class="box">
                    <div class="box-title">
                        <span>Stats</span> <span style="font-size:0.8em; text-transform:none; color:#556;">(Std: 3,2,2,1,1)</span>
                    </div>
                    <div class="stat-block-grid">
                        <div class="stat-cell"><input type="number" id="st-edge" value="3" onchange="updateStats()"><label>Edge</label></div>
                        <div class="stat-cell"><input type="number" id="st-heart" value="2" onchange="updateStats()"><label>Heart</label></div>
                        <div class="stat-cell"><input type="number" id="st-iron" value="2" onchange="updateStats()"><label>Iron</label></div>
                        <div class="stat-cell"><input type="number" id="st-shadow" value="1" onchange="updateStats()"><label>Shadow</label></div>
                        <div class="stat-cell"><input type="number" id="st-wits" value="1" onchange="updateStats()"><label>Wits</label></div>
                    </div>
                </div>
            </div>

            <div>
                <div class="box">
                    <div class="meter-grid">
                        <div class="meter-item" onmousedown="handleMeter(event, 'health')" oncontextmenu="return false;" ontouchstart="handleTouch(event, 'health')"><span class="meter-label">Health</span><span class="meter-val val-health" id="val-health">5</span></div>
                        <div class="meter-item" onmousedown="handleMeter(event, 'spirit')" oncontextmenu="return false;" ontouchstart="handleTouch(event, 'spirit')"><span class="meter-label">Spirit</span><span class="meter-val val-spirit" id="val-spirit">5</span></div>
                        <div class="meter-item" onmousedown="handleMeter(event, 'supply')" oncontextmenu="return false;" ontouchstart="handleTouch(event, 'supply')"><span class="meter-label">Supply</span><span class="meter-val val-supply" id="val-supply">5</span></div>
                    </div>
                </div>

                <div class="box" style="border-color:#556;">
                    <div class="box-title"><span>Momentum</span> <span id="val-momentum">+2</span></div>
                    <div class="mom-track" id="track-momentum"></div>
                </div>

                <div class="box">
                    <div class="box-title">Quests Legacy</div><div class="prog-track" id="leg-quests"></div>
                </div>
                <div class="box">
                    <div class="box-title">Bonds Legacy</div><div class="prog-track" id="leg-bonds"></div>
                </div>
                <div class="box">
                    <div class="box-title">Discoveries Legacy</div><div class="prog-track" id="leg-discoveries"></div>
                </div>
                
                <div class="box">
                    <div class="box-title">Experience</div>
                    <div class="xp-row">
                        <span>Earned: <span id="xp-earned" style="color:#fff;">0</span></span>
                        <span>Spent: <input type="number" id="xp-spent" value="0" style="width:50px; padding:2px; background:#111; color:#fff; border:1px solid #334;" onchange="calcXP()"></span>
                        <span>Available: <span id="xp-avail" style="color:var(--accent);">0</span></span>
                    </div>
                </div>
            </div>

            <div>
                <div class="box">
                    <div class="box-title">Progress Tracks</div>
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <input type="text" id="new-track-name" placeholder="Objective Name" style="flex-grow:1;">
                        <select id="new-track-type" style="width:100px;">
                            <option value="Vow">Vow</option>
                            <option value="Expedition">Expedition</option>
                            <option value="Connection">Connection</option>
                            <option value="Combat">Combat</option>
                        </select>
                    </div>
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <select id="new-track-rank" style="flex-grow:1;">
                            <option value="Troublesome">Troublesome (12)</option>
                            <option value="Dangerous">Dangerous (8)</option>
                            <option value="Formidable">Formidable (4)</option>
                            <option value="Extreme">Extreme (2)</option>
                            <option value="Epic">Epic (1)</option>
                        </select>
                        <button onclick="addProgressTrack()">ADD</button>
                    </div>
                    
                    <div id="track-list"></div>
                    
                    <div class="track-card rank-Epic" style="margin-top:20px; border-left-color: #c084fc;">
                        <div class="track-meta"><span>Vow</span><span>EPIC</span></div>
                        <div class="track-name" style="margin-bottom:5px;">Background Vow</div>
                        <div id="disp-vow" style="font-style:italic; font-size:0.8em; color:#aab; margin-bottom:5px;"></div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <button class="btn-mark btn-mark-neg" onclick="markBgVow(-1)">-</button>
                            <button class="btn-mark" onclick="markBgVow(1)">+</button>
                            <div class="prog-track" id="track-bg-vow" style="flex-grow:1;"></div>
                        </div>
                    </div>
                </div>

                <div class="box">
                    <div class="box-title" style="justify-content:space-between;">
                        <span>Asset Library</span>
                        <button onclick="deleteFromLibrary()" style="font-size:0.6em; padding:2px 6px; background:#300; border:none;">üóëÔ∏è</button>
                    </div>
                    <div id="db-drop-zone">Drop <b>Assets.csv</b> to update</div>
                    <input type="file" id="db-file-input" accept=".csv" onchange="handleAssetUpload(this.files)">
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <select id="asset-picker" style="flex-grow:1;"></select>
                        <button onclick="addAsset()" class="primary" style="padding:5px 10px;">+</button>
                    </div>
                    <div id="asset-list"></div>
                </div>
            </div>

        </div>
    </div>

<script>
    const RANK_TICKS = { "Troublesome": 12, "Dangerous": 8, "Formidable": 4, "Extreme": 2, "Epic": 1 };

    let char = {
        name: "", pronouns: "", look: "", vow: "",
        portrait: null,
        stats: { edge:3, heart:2, iron:2, shadow:1, wits:1 },
        meters: { health:5, spirit:5, supply:5, momentum:2 },
        impacts: [],
        legacies: { quests:0, bonds:0, discoveries:0 }, 
        bgVowProgress: 0,
        activeTracks: [],
        xpSpent: 0,
        assets: [] 
    };

    let assetLibrary = [
        { 
            category: "Module", name: "Archives", 
            a1: "When you Secure an Advantage or Gather Information using lore, modules, or sensors, add +1.", 
            a2: "When you Face Danger or React Under Fire to avoid physical harm, you may roll +wits.", 
            a3: "When you Undertake a Quest to recover data, mark progress twice.", 
            health: 0 
        },
        { 
            category: "Command Vehicle", name: "Starship", 
            a1: "Your armed, multipurpose starship is suited for interstellar and atmospheric flight. It can comfortably transport several people, has space for cargo, and can carry and launch support vehicles. When you Advance, you may spend experience to equip this vehicle with module assets.", 
            a2: "When you Finish an Expedition (dangerous or greater) in your starship and score a hit, this journey strengthened your ties to your ship and any fellow travelers. You and your allies may mark 1 tick on your bonds legacy track.", 
            a3: "When you Withstand Damage, you may roll +heart. If you do, Endure Stress (-1) on a weak hit or miss.", 
            health: 5 
        },
        { 
            category: "Companion", name: "Sidekick", 
            a1: "Your sidekick has a helpful expertise. When you make a move outside of a fight directly aided by their expertise, you may reroll your action die if its value is less than your sidekick‚Äôs health. If you then score a strong hit with a match, mark 1 tick on your bonds legacy track.", 
            a2: "When you Enter the Fray with the support of your sidekick, take +2 momentum on a hit. When you Clash together, add +1.", 
            a3: "When your sidekick acts to get you out of a tough spot, you may Face Danger or React Under Fire and roll +their health (instead of your own stat). On a hit, take +1 momentum.", 
            health: 4 
        }
    ];

    function init() {
        const savedLib = localStorage.getItem('sf_asset_lib');
        if(savedLib) assetLibrary = JSON.parse(savedLib);
        sanitizeChar(); // Fix missing data structure from old saves
        populateAssetPicker();
        
        const dropZone = document.getElementById('db-drop-zone');
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('hover'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('hover'); });
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('hover'); handleAssetUpload(e.dataTransfer.files); });
        dropZone.addEventListener('click', () => document.getElementById('db-file-input').click());
    }

    function sanitizeChar() {
        if(!char.activeTracks) char.activeTracks = [];
        if(!char.assets) char.assets = [];
        if(!char.impacts) char.impacts = [];
        if(!char.legacies) char.legacies = { quests:0, bonds:0, discoveries:0 };
    }

    // --- PORTRAIT ---
    function loadPortrait(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) { char.portrait = e.target.result; renderPortrait(); }
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    function renderPortrait() {
        const el = document.getElementById('char-portrait');
        if(char.portrait) { el.style.backgroundImage = `url(${char.portrait})`; el.innerHTML = ''; }
        else { el.style.backgroundImage = 'none'; el.innerHTML = ''; }
    }

    // --- METERS ---
    function handleMeter(e, key) {
        e.preventDefault();
        char.meters[key] = (e.button === 2) ? Math.max(0, char.meters[key] - 1) : Math.min(5, char.meters[key] + 1);
        document.getElementById(`val-${key}`).innerText = char.meters[key];
    }
    
    function handleTouch(e, key) {
        e.preventDefault();
        touchTimer = setTimeout(() => {
            touchTimer = null; char.meters[key] = Math.max(0, char.meters[key] - 1);
            document.getElementById(`val-${key}`).innerText = char.meters[key];
        }, 500); 
        e.target.addEventListener('touchend', () => {
            if(touchTimer) { clearTimeout(touchTimer); char.meters[key] = Math.min(5, char.meters[key] + 1);
            document.getElementById(`val-${key}`).innerText = char.meters[key]; touchTimer = null; }
        }, {once:true});
    }

    // --- ASSETS LOGIC ---
    function handleAssetUpload(files) {
        if(files.length === 0) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const rows = e.target.result.split(/\r?\n/).map(r => r.trim()).filter(r => r);
            const newLib = [];
            for(let i=1; i<rows.length; i++) {
                const cols = rows[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim());
                if(cols.length >= 6) {
                    newLib.push({
                        category: cols[0], name: cols[1], a1: cols[2], a2: cols[3], a3: cols[4],
                        health: parseInt(cols[5]) || 0
                    });
                }
            }
            if(newLib.length > 0) {
                newLib.forEach(newItem => {
                    const exists = assetLibrary.some(ex => ex.name === newItem.name && ex.category === newItem.category);
                    if(!exists) assetLibrary.push(newItem);
                });
                localStorage.setItem('sf_asset_lib', JSON.stringify(assetLibrary));
                populateAssetPicker();
                document.getElementById('db-drop-zone').innerText = `Added ${newLib.length} Assets!`;
                document.getElementById('db-drop-zone').style.borderColor = "#4ade80";
                document.getElementById('db-drop-zone').style.color = "#4ade80";
            }
        };
        reader.readAsText(files[0]);
    }
    
    function deleteFromLibrary() {
        const sel = document.getElementById('asset-picker');
        const idx = parseInt(sel.value);
        if(isNaN(idx)) return;
        const item = assetLibrary[idx];
        if(!item) return;
        if(confirm(`Delete "${item.name}" from library?`)) {
            assetLibrary.splice(idx, 1);
            localStorage.setItem('sf_asset_lib', JSON.stringify(assetLibrary));
            populateAssetPicker();
        }
    }

    function populateAssetPicker() {
        const sel = document.getElementById('asset-picker');
        sel.innerHTML = '';
        assetLibrary.sort((a,b) => a.category.localeCompare(b.category) || a.name.localeCompare(b.name));
        assetLibrary.forEach((a, idx) => {
            const opt = document.createElement('option');
            opt.value = idx; opt.innerText = `[${a.category}] ${a.name}`;
            sel.appendChild(opt);
        });
    }

    function addAsset() {
        if(assetLibrary.length === 0) { alert("Library Empty"); return; }
        const idx = document.getElementById('asset-picker').value;
        const template = assetLibrary[idx];
        char.assets.push({
            category: template.category, baseName: template.name,
            customName: "", misc1: "", misc2: "",
            abilities: [true, false, false],
            abilityText: [template.a1, template.a2, template.a3],
            health: template.health, maxHealth: template.health,
            troubles: [] 
        });
        renderAll();
    }

    // --- RENDER ---
    function finishWizard() {
        char.name = document.getElementById('in-name').value || "Unknown";
        char.pronouns = document.getElementById('in-pronouns').value;
        char.vow = document.getElementById('in-vow').value;
        document.getElementById('wizard-container').style.display = 'none';
        document.getElementById('dashboard-container').style.display = 'flex';
        renderAll();
    }

    function renderAll() {
        document.getElementById('disp-name').innerText = char.name;
        document.getElementById('disp-pronouns').innerText = char.pronouns;
        document.getElementById('disp-vow').innerText = char.vow;
        renderPortrait();
        ['edge','heart','iron','shadow','wits'].forEach(s => document.getElementById('st-'+s).value = char.stats[s]);
        document.getElementById('xp-spent').value = char.xpSpent;
        ['health','spirit','supply'].forEach(k => document.getElementById(`val-${k}`).innerText = char.meters[k]);

        renderImpacts();

        renderLegacyTrack('leg-quests', char.legacies.quests, (v) => { char.legacies.quests = v; calcXP(); });
        renderLegacyTrack('leg-bonds', char.legacies.bonds, (v) => { char.legacies.bonds = v; calcXP(); });
        renderLegacyTrack('leg-discoveries', char.legacies.discoveries, (v) => { char.legacies.discoveries = v; calcXP(); });
        
        renderVisualTrack('track-bg-vow', char.bgVowProgress);

        renderActiveTracks();
        renderAssets();
        calcXP();
    }

    // --- CORE LOGIC ---
    function toggleImpact(key) {
        if(char.impacts.includes(key)) char.impacts = char.impacts.filter(k => k !== key);
        else char.impacts.push(key);
        renderAll(); 
    }
    
    function toggleAssetTrouble(idx, trouble) {
        const a = char.assets[idx];
        if(!a.troubles) a.troubles = [];
        if(a.troubles.includes(trouble)) a.troubles = a.troubles.filter(t => t !== trouble);
        else a.troubles.push(trouble);
        renderAll(); 
    }

    function renderImpacts() {
        document.querySelectorAll('.impact-toggle').forEach(el => el.classList.remove('active'));
        char.impacts.forEach(k => {
            const el = document.querySelector(`.impact-toggle[onclick="toggleImpact('${k}')"]`);
            if(el) el.classList.add('active');
        });

        let totalImpacts = char.impacts.length;
        char.assets.forEach(a => { 
            if(a.troubles) {
                const vehTroubles = a.troubles.filter(t => t !== 'outOfAction');
                totalImpacts += vehTroubles.length; 
            }
        });

        let maxMom = 10 - totalImpacts;
        if(maxMom < 0) maxMom = 0;
        let resetMom = totalImpacts <= 1 ? (totalImpacts === 0 ? 2 : 1) : 0;

        document.getElementById('disp-max-mom').innerText = maxMom;
        document.getElementById('disp-reset-mom').innerText = "+" + resetMom;
        renderMomentum(maxMom, resetMom);
    }

    function renderMomentum(max, reset) {
        const c = document.getElementById('track-momentum');
        c.innerHTML = '';
        const min = -6;
        if(char.meters.momentum > max) char.meters.momentum = max;
        if(char.meters.momentum < min) char.meters.momentum = min;

        for(let i=10; i>=min; i--) {
            const step = document.createElement('div');
            step.className = 'mom-step';
            step.innerText = i;
            if (i > max) step.classList.add('disabled');
            if (i === char.meters.momentum) step.classList.add('active');
            if (i === reset) step.classList.add('reset');
            if (i === max) step.classList.add('max');
            if (i <= max) {
                step.onclick = () => { char.meters.momentum = i; renderAll(); };
            }
            c.appendChild(step);
        }
        document.getElementById('val-momentum').innerText = (char.meters.momentum > 0 ? "+" : "") + char.meters.momentum;
    }

    function renderLegacyTrack(id, currentTicks, callback) {
        const c = document.getElementById(id);
        c.innerHTML = '';
        for(let i=0; i<10; i++) {
            const box = document.createElement('div');
            box.className = 'prog-box';
            let boxTicks = 0;
            if (currentTicks >= (i+1)*4) boxTicks = 4;
            else if (currentTicks > i*4) boxTicks = currentTicks % 4;
            box.dataset.ticks = boxTicks;
            
            box.onclick = () => { if(currentTicks < 40) { callback(currentTicks + 1); renderAll(); } };
            box.oncontextmenu = (e) => { e.preventDefault(); if(currentTicks > 0) { callback(currentTicks - 1); renderAll(); } };
            c.appendChild(box);
        }
    }

    function renderVisualTrack(id, currentTicks) {
        const c = document.getElementById(id);
        c.innerHTML = '';
        for(let i=0; i<10; i++) {
            const box = document.createElement('div');
            box.className = 'prog-box';
            let boxTicks = 0;
            if (currentTicks >= (i+1)*4) boxTicks = 4;
            else if (currentTicks > i*4) boxTicks = currentTicks % 4;
            box.dataset.ticks = boxTicks;
            c.appendChild(box);
        }
    }

    function renderAssets() {
        const c = document.getElementById('asset-list');
        c.innerHTML = '';
        char.assets.forEach((a, idx) => {
            const isVehicle = (a.category === "Command Vehicle" || a.category === "Support Vehicle");
            const isCommand = (a.category === "Command Vehicle");
            const isCompanion = (a.category === "Companion");
            
            const isBattered = a.troubles && a.troubles.includes('battered');
            const isCursed = a.troubles && a.troubles.includes('cursed');
            const isOOA = a.troubles && a.troubles.includes('outOfAction');

            let healthTrack = '';
            if(a.maxHealth > 0) {
                // Lock track if Battered or OOA
                const isLocked = isBattered || isOOA;
                healthTrack = `<div class="track-row ${isLocked ? 'locked' : ''}" style="margin-top:8px;">`;
                for(let h=1; h<=a.maxHealth; h++) { 
                     healthTrack += `<div style="flex:1; height:8px; background:${h<=a.health?'#fff':'#333'}; border:1px solid #000; cursor:pointer;" onclick="updateAssetHealth(${idx}, ${h})"></div>`;
                }
                healthTrack += `</div>`;
            }
            
            let troublesUI = '';
            if(isVehicle) {
                troublesUI = `<div class="trouble-box">`;
                troublesUI += `<span class="trouble-toggle ${isBattered?'active':''}" onclick="toggleAssetTrouble(${idx}, 'battered')">Battered</span>`;
                if(isCommand) troublesUI += `<span class="trouble-toggle ${isCursed?'active':''}" onclick="toggleAssetTrouble(${idx}, 'cursed')">Cursed</span>`;
                troublesUI += `</div>`;
            } else if (isCompanion) {
                troublesUI = `<div class="trouble-box">`;
                troublesUI += `<span class="trouble-toggle ${isOOA?'active':''}" onclick="toggleAssetTrouble(${idx}, 'outOfAction')">Out of Action</span>`;
                troublesUI += `</div>`;
            }

            const div = document.createElement('div');
            div.className = `asset-card ${isOOA ? 'disabled' : ''}`;
            div.innerHTML = `
                <div class="asset-header"><span class="asset-cat">${a.category}</span><button onclick="removeAsset(${idx})" style="font-size:0.6em; padding:2px 5px; background:#300; border:none;">X</button></div>
                <div style="font-weight:bold; color:#fff; margin-bottom:5px;">${a.baseName}</div>
                <input type="text" class="asset-input" placeholder="Custom Name" value="${a.customName}" onchange="char.assets[${idx}].customName=this.value">
                <div style="margin-top:10px;">
                    <div class="ability-row"><input type="checkbox" class="ability-chk" ${a.abilities[0]?'checked':''} onchange="char.assets[${idx}].abilities[0]=this.checked"><span class="ability-text">${a.abilityText[0]}</span></div>
                    <div class="ability-row"><input type="checkbox" class="ability-chk" ${a.abilities[1]?'checked':''} onchange="char.assets[${idx}].abilities[1]=this.checked"><span class="ability-text">${a.abilityText[1]}</span></div>
                    <div class="ability-row"><input type="checkbox" class="ability-chk" ${a.abilities[2]?'checked':''} onchange="char.assets[${idx}].abilities[2]=this.checked"><span class="ability-text">${a.abilityText[2]}</span></div>
                </div>
                ${healthTrack} ${troublesUI}
                <div class="misc-row">
                    <input type="text" class="misc-input" placeholder="Notes" value="${a.misc1}" onchange="char.assets[${idx}].misc1=this.value">
                    <input type="text" class="misc-input" placeholder="Cargo" value="${a.misc2}" onchange="char.assets[${idx}].misc2=this.value">
                </div>`;
            c.appendChild(div);
        });
    }

    function addProgressTrack() {
        const name = document.getElementById('new-track-name').value;
        if(!name) { alert("Please enter a track name"); return; }
        
        const type = document.getElementById('new-track-type').value;
        const rank = document.getElementById('new-track-rank').value;
        char.activeTracks.push({ id: Date.now(), name: name, type: type, rank: rank, progress: 0 });
        document.getElementById('new-track-name').value = '';
        renderActiveTracks();
    }

    function updateTrackProgress(id, delta) {
        const track = char.activeTracks.find(t => t.id === id);
        if(track) {
            track.progress = Math.max(0, Math.min(40, track.progress + delta));
            renderActiveTracks();
        }
    }

    function markBgVow(delta) {
        char.bgVowProgress = Math.max(0, Math.min(40, char.bgVowProgress + delta));
        renderVisualTrack('track-bg-vow', char.bgVowProgress);
    }

    function removeTrack(id) {
        if(confirm("Remove track?")) {
            char.activeTracks = char.activeTracks.filter(t => t.id !== id);
            renderActiveTracks();
        }
    }

    function renderActiveTracks() {
        const c = document.getElementById('track-list');
        c.innerHTML = '';
        char.activeTracks.forEach(t => {
            const div = document.createElement('div');
            div.className = `track-card rank-${t.rank}`;
            div.innerHTML = `
                <div class="track-meta"><span>${t.type}</span><span>${t.rank.toUpperCase()}</span><button onclick="removeTrack(${t.id})" style="font-size:0.6em; padding:1px 4px; background:#300; border:none; margin-left:5px;">X</button></div>
                <div class="track-name" style="margin-bottom:5px;">${t.name}</div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <button class="btn-mark btn-mark-neg" onclick="updateTrackProgress(${t.id}, -${RANK_TICKS[t.rank]})">-</button>
                    <button class="btn-mark" onclick="updateTrackProgress(${t.id}, ${RANK_TICKS[t.rank]})">+ Mark</button>
                    <div class="prog-track" id="track-viz-${t.id}" style="flex-grow:1;"></div>
                </div>
            `;
            c.appendChild(div);
            renderVisualTrack(`track-viz-${t.id}`, t.progress);
        });
    }

    function updateAssetHealth(idx, val) {
        if(char.assets[idx].troubles && char.assets[idx].troubles.includes('battered') && val > char.assets[idx].health) {
            alert("Cannot repair Battered vehicle. Clear trouble first."); return;
        }
        if (char.assets[idx].health === val) char.assets[idx].health = val - 1; else char.assets[idx].health = val;
        renderAll();
    }

    function removeAsset(idx) { if(confirm("Discard?")) { char.assets.splice(idx, 1); renderAll(); } }
    function updateStats() { ['edge','heart','iron','shadow','wits'].forEach(s => char.stats[s] = parseInt(document.getElementById('st-'+s).value) || 0); }
    function calcXP() {
        const total = char.legacies.quests + char.legacies.bonds + char.legacies.discoveries;
        const earned = Math.floor(total/4)*2;
        char.xpSpent = parseInt(document.getElementById('xp-spent').value)||0;
        document.getElementById('xp-earned').innerText = earned;
        document.getElementById('xp-avail').innerText = earned - char.xpSpent;
    }
    function saveCharacter() {
        const data = JSON.stringify(char, null, 2);
        const url = URL.createObjectURL(new Blob([data], {type: 'application/json'}));
        const a = document.createElement('a'); a.href = url; a.download = `${char.name.replace(/\s/g,'_')}_Profile.json`; a.click();
    }
    function loadCharacter(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                char = JSON.parse(e.target.result);
                sanitizeChar();
                document.getElementById('wizard-container').style.display = 'none';
                document.getElementById('dashboard-container').style.display = 'flex';
                renderAll();
            } catch(err) { alert("Invalid Save"); }
        };
        reader.readAsText(file);
    }
    init();

</script>
</body>
</html>
